---
title: Deployment Guide
description: Comprehensive guide for deploying and operating the Fractal Engine service in production environments
---

# Fractal Engine Deployment Guide

This comprehensive guide covers deploying and operating the Fractal Engine service in production environments.

## Overview

The Fractal Engine is a microservices-based tokenization system for the Dogecoin blockchain. The main service orchestrates multiple components including RPC servers, database operations, blockchain following, health monitoring, and transaction processing.

### Architecture Components

- **TokenisationService**: Main service orchestrator managing component lifecycle
- **FractalEngineProcessor**: Core transaction processing engine
- **DogeNetClient**: Network communication and peer discovery
- **DogeFollower**: Blockchain synchronization and monitoring
- **RpcServer**: RESTful API for external integrations
- **HealthService**: System health monitoring and alerting
- **TokenisationStore**: Data persistence layer with migrations

## System Requirements

### Hardware Requirements

**Minimum Production Requirements:**
- **CPU**: 4 cores, 2.4GHz+
- **RAM**: 8GB minimum, 16GB recommended
- **Storage**: 100GB SSD (for blockchain data and SQLite/PostgreSQL)
- **Network**: 1Gbps connection, stable internet

**Recommended Production Requirements:**
- **CPU**: 8 cores, 3.0GHz+
- **RAM**: 32GB
- **Storage**: 500GB NVMe SSD
- **Network**: 10Gbps connection

### Software Dependencies

- **Go**: 1.24.2+ (for source builds)
- **Docker**: 24.0+ and Docker Compose 2.0+
- **Database**: SQLite 3.40+ or PostgreSQL 15+
- **Operating System**: Linux (Ubuntu 22.04+, CentOS 8+, Debian 12+)

### Network Requirements

- **Inbound Ports**: 
  - 8891 (Fractal Engine API)
  - 8899 (Balance Master, optional)
  - 22556 (Dogecoin RPC)
- **Outbound**: Full internet access for blockchain synchronization
- **Internal**: Docker network communication on 192.168.x.0/24

## Installation Methods

### Docker Deployment (Recommended)

#### Quick Start with Docker Compose

1. **Clone and prepare environment:**
```bash
git clone https://github.com/dogecoinfoundation/fractal-engine.git
cd fractal-engine
```

2. **Start complete stack:**
```bash
./scripts/run-stack.sh 1 deps,fractal
```

3. **Verify deployment:**
```bash
curl http://localhost:8891/health
```

#### Manual Docker Compose Setup

```bash
# Create shared network
docker network create fractal-shared

# Set environment variables
export INSTANCE_ID=1
export DOGE_PORT=22556
export FRACTAL_PORT=8891
export POSTGRES_PORT=5432

# Deploy services
docker-compose --profile deps --profile fractal up -d --build
```

### Binary Installation

#### Pre-built Binaries

```bash
# Build from source
make binaries

# Install to system location
sudo cp bin/fractal-engine /usr/local/bin/
sudo cp bin/fractal-admin /usr/local/bin/

# Create service user
sudo useradd -r -s /bin/false fractalengine

# Create directories
sudo mkdir -p /var/lib/fractalengine
sudo chown fractalengine:fractalengine /var/lib/fractalengine
```

#### Systemd Service

Create `/etc/systemd/system/fractalengine.service`:

```ini
[Unit]
Description=Fractal Engine Tokenisation Service
After=network.target
Requires=network.target

[Service]
Type=simple
User=fractalengine
Group=fractalengine
WorkingDirectory=/var/lib/fractalengine
ExecStart=/usr/local/bin/fractal-engine \
  -rpc-server-host 0.0.0.0 \
  -rpc-server-port 8891 \
  -doge-host localhost \
  -doge-port 22556 \
  -doge-user test \
  -doge-password test \
  -database-url sqlite:///var/lib/fractalengine/fractal-engine.db \
  -persist-follower true
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl daemon-reload
sudo systemctl enable fractalengine
sudo systemctl start fractalengine
```

### Source Installation

#### Prerequisites

```bash
# Install Go 1.24.2+
wget https://golang.org/dl/go1.24.2.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.24.2.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc

# Install build dependencies
sudo apt-get update
sudo apt-get install -y git pkg-config libsystemd-dev
```

#### Build and Install

```bash
# Clone repository
git clone https://github.com/dogecoinfoundation/fractal-engine.git
cd fractal-engine

# Download dependencies
go mod download

# Build all binaries
make binaries

# Run tests
make test

# Install
sudo cp bin/* /usr/local/bin/
```

## Environment Setup

### Network Configurations

#### Mainnet Configuration

```bash
# Environment variables for mainnet
export DOGE_HOST=localhost
export DOGE_PORT=22556
export DOGE_USER=your_rpc_user
export DOGE_PASSWORD=your_rpc_password
export DATABASE_URL=sqlite:///var/lib/fractalengine/mainnet.db
export FRACTAL_PORT=8891
export DOGE_NET_NETWORK=tcp
export DOGE_NET_ADDRESS=dogenet.dogeorg.org:9999
```

#### Testnet Configuration

```bash
# Environment variables for testnet
export DOGE_HOST=localhost
export DOGE_PORT=44556
export DOGE_USER=test
export DOGE_PASSWORD=test
export DATABASE_URL=sqlite:///var/lib/fractalengine/testnet.db
export FRACTAL_PORT=18891
export DOGE_NET_NETWORK=tcp
export DOGE_NET_ADDRESS=testnet-dogenet.dogeorg.org:19999
```

#### Regtest Configuration

```bash
# Environment variables for regtest
export DOGE_HOST=localhost
export DOGE_PORT=18444
export DOGE_USER=test
export DOGE_PASSWORD=test
export DATABASE_URL=sqlite:///var/lib/fractalengine/regtest.db
export FRACTAL_PORT=28891
export DOGE_NET_NETWORK=unix
export DOGE_NET_ADDRESS=/tmp/dogenet.sock
```

### Dogecoin Node Setup

#### regtest.conf Example

```ini
regtest=1
rpcuser=test
rpcpassword=test
rpcport=18444
server=1
txindex=1
rpcbind=0.0.0.0
rpcallowip=0.0.0.0/0
```

## Service Configuration

### Command Line Options

```bash
fractal-engine \
  -rpc-server-host 0.0.0.0 \
  -rpc-server-port 8891 \
  -doge-scheme http \
  -doge-host localhost \
  -doge-port 22556 \
  -doge-user your_user \
  -doge-password your_password \
  -database-url sqlite:///path/to/database.db \
  -doge-net-network tcp \
  -doge-net-address dogenet.host:port \
  -persist-follower true
```

### Configuration File (config.toml)

```toml
fractal_engine_host = "0.0.0.0"
fractal_engine_port = "8891"
balance_master_host = "localhost"
balance_master_port = "8899"
doge_scheme = "http"
doge_host = "localhost"
doge_port = "22556"
doge_user = "your_user"
doge_password = "your_password"
key_labels = ["seller", "buyer"]
active_key = "seller"
```

### Database Configuration

#### SQLite (Development/Single Instance)

```bash
DATABASE_URL=sqlite:///var/lib/fractalengine/fractal-engine.db
```

#### PostgreSQL (Production)

```bash
DATABASE_URL=postgres://user:password@localhost:5432/fractalstore
```

### Startup Procedures

The service follows this startup sequence:

1. **Database Migration**: Automatic schema updates
2. **DogeNet Client**: Network layer initialization
3. **Health Service**: System monitoring activation
4. **RPC Server**: API endpoint startup
5. **Doge Follower**: Blockchain synchronization
6. **Processor**: Transaction processing engine

## Health Monitoring and Logging

### Health Endpoints

- **Primary Health Check**: `GET /health`
- **Detailed Metrics**: `GET /health/detailed`

```bash
# Basic health check
curl http://localhost:8891/health

# Returns: {"status":"healthy","timestamp":"2024-01-01T00:00:00Z"}
```

### Health Monitoring Components

The HealthService monitors:
- **Blockchain Connectivity**: Dogecoin node availability
- **Database Health**: Connection and query performance
- **Wallet Status**: RPC wallet accessibility
- **Sync Status**: Current vs latest block height
- **Chain Detection**: Network identification (mainnet/testnet/regtest)

### Logging Configuration

#### Standard Logging

```bash
# Systemd journal logs
journalctl -u fractalengine -f

# Docker logs
docker-compose logs -f fractalengine
```

#### Production Logging with External Tools

```bash
# Configure log rotation
sudo tee /etc/logrotate.d/fractalengine << EOF
/var/log/fractalengine/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 fractalengine fractalengine
    postrotate
        systemctl reload fractalengine
    endscript
}
EOF
```

## Security Hardening

### Network Security

#### Firewall Configuration

```bash
# UFW rules
sudo ufw allow 8891/tcp comment 'Fractal Engine API'
sudo ufw allow 22556/tcp comment 'Dogecoin RPC'
sudo ufw deny 5432/tcp comment 'PostgreSQL (internal only)'

# Restrict RPC access
sudo ufw allow from 10.0.0.0/8 to any port 22556
sudo ufw allow from 172.16.0.0/12 to any port 22556
sudo ufw allow from 192.168.0.0/16 to any port 22556
```

#### TLS/SSL Configuration

```bash
# Generate certificates
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# Configure reverse proxy (nginx)
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://localhost:8891;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### Authentication and Authorization

#### API Key Authentication

```bash
# Set environment variable for API key
export FRACTAL_API_KEY=your-secure-api-key-here

# Configure in systemd service
Environment=FRACTAL_API_KEY=your-secure-api-key-here
```

#### Dogecoin RPC Security

```bash
# Use strong credentials
export DOGE_USER=$(openssl rand -hex 16)
export DOGE_PASSWORD=$(openssl rand -hex 32)

# Restrict RPC access in dogecoin.conf
rpcallowip=127.0.0.1
rpcallowip=::1
rpcbind=127.0.0.1
```

### File System Security

```bash
# Secure database files
sudo chmod 600 /var/lib/fractalengine/*.db
sudo chown fractalengine:fractalengine /var/lib/fractalengine/*.db

# Secure configuration files
sudo chmod 640 /etc/fractalengine/config.toml
sudo chown root:fractalengine /etc/fractalengine/config.toml
```

## Load Balancing and Scaling

### Horizontal Scaling

#### Multiple Instance Deployment

```bash
# Deploy multiple instances with different ports
./scripts/run-stack.sh 1 deps,fractal  # Ports 8102, 14658, etc.
./scripts/run-stack.sh 2 deps,fractal  # Ports 8202, 14658, etc.
./scripts/run-stack.sh 3 deps,fractal  # Ports 8302, 14660, etc.
```

#### Load Balancer Configuration (HAProxy)

```nginx
global
    daemon
    
defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend fractal_frontend
    bind *:443 ssl crt /etc/ssl/certs/fractalengine.pem
    default_backend fractal_backend

backend fractal_backend
    balance roundrobin
    option httpchk GET /health
    server fractal1 localhost:8891 check
    server fractal2 localhost:8991 check
    server fractal3 localhost:9091 check
```

#### Nginx Load Balancer

```nginx
upstream fractal_backend {
    least_conn;
    server localhost:8891 max_fails=3 fail_timeout=30s;
    server localhost:8991 max_fails=3 fail_timeout=30s;
    server localhost:9091 max_fails=3 fail_timeout=30s;
}

server {
    listen 443 ssl;
    server_name fractal.yourdomain.com;
    
    location / {
        proxy_pass http://fractal_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location /health {
        access_log off;
        proxy_pass http://fractal_backend;
    }
}
```

### Database Scaling

#### PostgreSQL High Availability

```yaml
# docker-compose.yml for PostgreSQL cluster
services:
  postgres-primary:
    image: postgres:15
    environment:
      POSTGRES_REPLICATION_MODE: master
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: repl_password
      
  postgres-replica:
    image: postgres:15
    environment:
      POSTGRES_REPLICATION_MODE: slave
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: repl_password
      POSTGRES_MASTER_SERVICE: postgres-primary
```

## Backup and Disaster Recovery

### Database Backups

#### SQLite Backup Strategy

```bash
#!/bin/bash
# SQLite backup script
BACKUP_DIR="/var/backups/fractalengine"
DB_PATH="/var/lib/fractalengine/fractal-engine.db"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Create backup with SQLite .backup command
sqlite3 "$DB_PATH" ".backup '$BACKUP_DIR/fractal-engine_$TIMESTAMP.db'"

# Compress backup
gzip "$BACKUP_DIR/fractal-engine_$TIMESTAMP.db"

# Remove backups older than 30 days
find "$BACKUP_DIR" -name "*.gz" -mtime +30 -delete

# Verify backup integrity
if zcat "$BACKUP_DIR/fractal-engine_$TIMESTAMP.db.gz" | sqlite3 :memory: ".schema" > /dev/null; then
    echo "Backup verified successfully"
else
    echo "Backup verification failed"
    exit 1
fi
```

#### PostgreSQL Backup Strategy

```bash
#!/bin/bash
# PostgreSQL backup script
BACKUP_DIR="/var/backups/fractalengine"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
DB_NAME="fractalstore"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Create compressed backup
pg_dump -h localhost -U fractalstore -d "$DB_NAME" | gzip > "$BACKUP_DIR/fractalstore_$TIMESTAMP.sql.gz"

# Point-in-time recovery setup
pg_basebackup -h localhost -D "$BACKUP_DIR/base_$TIMESTAMP" -c fast -P -U replicator -W
```

### Automated Backup with Cron

```bash
# Add to crontab
crontab -e

# Daily database backup at 2 AM
0 2 * * * /usr/local/bin/fractal-backup.sh >> /var/log/fractal-backup.log 2>&1

# Weekly full system backup
0 3 * * 0 tar -czf /var/backups/fractalengine/system_$(date +\%Y\%m\%d).tar.gz /var/lib/fractalengine /etc/fractalengine
```

### Disaster Recovery Procedures

#### Service Recovery Steps

1. **Assess Damage**: Check logs and system status
2. **Restore Database**: From latest backup
3. **Verify Configuration**: Ensure all settings are correct
4. **Restart Services**: In proper dependency order
5. **Validate Operation**: Run health checks and test API

```bash
#!/bin/bash
# Disaster recovery script
set -e

echo "Starting disaster recovery..."

# Stop services
systemctl stop fractalengine

# Restore database from backup
LATEST_BACKUP=$(ls -t /var/backups/fractalengine/fractal-engine_*.gz | head -n1)
echo "Restoring from backup: $LATEST_BACKUP"

# Backup current corrupted database
mv /var/lib/fractalengine/fractal-engine.db /var/lib/fractalengine/fractal-engine.db.corrupted

# Restore from backup
zcat "$LATEST_BACKUP" > /var/lib/fractalengine/fractal-engine.db
chown fractalengine:fractalengine /var/lib/fractalengine/fractal-engine.db

# Start services
systemctl start fractalengine

# Wait for service to be ready
sleep 30

# Verify health
curl -f http://localhost:8891/health || exit 1

echo "Disaster recovery completed successfully"
```

## Monitoring and Alerting

### Prometheus Integration

#### Custom Metrics Exporter

```go
// metrics.go - Add to your service
package main

import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
    "net/http"
)

var (
    processedTransactions = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "fractal_transactions_processed_total",
            Help: "Total number of processed transactions",
        },
        []string{"type", "status"},
    )
    
    currentBlockHeight = prometheus.NewGauge(
        prometheus.GaugeOpts{
            Name: "fractal_current_block_height",
            Help: "Current blockchain height",
        },
    )
)

func init() {
    prometheus.MustRegister(processedTransactions)
    prometheus.MustRegister(currentBlockHeight)
}

func startMetricsServer() {
    http.Handle("/metrics", promhttp.Handler())
    http.ListenAndServe(":9090", nil)
}
```

#### Prometheus Configuration

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'fractal-engine'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: /metrics
    scrape_interval: 5s
```

### Grafana Dashboards

#### Key Metrics Dashboard

```json
{
  "dashboard": {
    "title": "Fractal Engine Monitoring",
    "panels": [
      {
        "title": "Transaction Processing Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(fractal_transactions_processed_total[5m])"
          }
        ]
      },
      {
        "title": "Block Height Sync Status",
        "type": "stat",
        "targets": [
          {
            "expr": "fractal_current_block_height"
          }
        ]
      },
      {
        "title": "Service Health",
        "type": "stat",
        "targets": [
          {
            "expr": "up{job=\"fractal-engine\"}"
          }
        ]
      }
    ]
  }
}
```

### Alerting Rules

#### AlertManager Configuration

```yaml
# alertmanager.yml
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@yourdomain.com'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'team-alerts'

receivers:
- name: 'team-alerts'
  email_configs:
  - to: 'admin@yourdomain.com'
    subject: 'Fractal Engine Alert: {{ .GroupLabels.alertname }}'
    body: |
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      {{ end }}
```

#### Prometheus Alert Rules

```yaml
# alerts.yml
groups:
- name: fractal-engine
  rules:
  - alert: FractalEngineDown
    expr: up{job="fractal-engine"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Fractal Engine service is down"
      description: "Fractal Engine has been down for more than 1 minute"
      
  - alert: HighTransactionProcessingDelay
    expr: increase(fractal_transactions_pending[5m]) > 100
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High transaction processing delay"
      description: "Transaction queue is growing rapidly"
      
  - alert: BlockSyncLagging
    expr: (fractal_latest_block_height - fractal_current_block_height) > 5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Block synchronization lagging"
      description: "Node is {{ $value }} blocks behind"
```

## Performance Tuning

### Database Optimization

#### SQLite Tuning

```sql
-- Apply these PRAGMA settings for better performance
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA cache_size = 10000;
PRAGMA temp_store = memory;
PRAGMA mmap_size = 268435456; -- 256MB
```

#### PostgreSQL Tuning

```sql
-- postgresql.conf optimizations
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
```

### Application Performance

#### Go Runtime Tuning

```bash
# Environment variables for Go runtime
export GOGC=100
export GOMAXPROCS=8
export GOMEMLIMIT=8GiB
```

#### Service Configuration Tuning

```bash
# Optimize for high throughput
fractal-engine \
  -rpc-server-host 0.0.0.0 \
  -rpc-server-port 8891 \
  -doge-host localhost \
  -doge-port 22556 \
  -database-url "sqlite:///var/lib/fractalengine/fractal-engine.db?cache=shared&mode=rwc&_journal_mode=WAL" \
  -persist-follower true \
  -worker-pool-size 16 \
  -batch-size 100
```

### Network Optimization

#### TCP Tuning

```bash
# /etc/sysctl.conf network optimizations
net.core.somaxconn = 1024
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# Apply changes
sudo sysctl -p
```

## Troubleshooting

### Common Issues and Solutions

#### Service Won't Start

**Symptoms**: Service fails to start, immediate exit
**Diagnosis**:
```bash
# Check logs
journalctl -u fractalengine -n 50

# Check configuration
fractal-engine -config-check

# Test database connection
sqlite3 /var/lib/fractalengine/fractal-engine.db ".schema"
```

**Solutions**:
- Verify database permissions and path
- Check Dogecoin node connectivity
- Validate configuration syntax
- Ensure required ports are available

#### High Memory Usage

**Symptoms**: Increasing memory consumption, potential OOM kills
**Diagnosis**:
```bash
# Monitor memory usage
ps aux | grep fractal-engine
top -p $(pgrep fractal-engine)

# Check for memory leaks
valgrind --tool=memcheck ./fractal-engine [options]
```

**Solutions**:
- Tune GOGC environment variable
- Implement proper connection pooling
- Add memory limits to systemd service
- Consider database query optimization

#### Slow Transaction Processing

**Symptoms**: Delayed transaction confirmations, growing queue
**Diagnosis**:
```bash
# Check database performance
sqlite3 /var/lib/fractalengine/fractal-engine.db ".timer on" ".explain query plan SELECT ..."

# Monitor system resources
iostat -x 1
sar -u 1

# Check network latency to Dogecoin node
ping -c 10 localhost
```

**Solutions**:
- Optimize database queries and indexes
- Increase worker pool size
- Improve database storage (SSD vs HDD)
- Tune batch processing parameters

#### Database Corruption

**Symptoms**: Database errors, integrity check failures
**Diagnosis**:
```bash
# Check database integrity
sqlite3 /var/lib/fractalengine/fractal-engine.db "PRAGMA integrity_check;"

# Analyze corruption extent
sqlite3 /var/lib/fractalengine/fractal-engine.db ".recover" > recovered.sql
```

**Solutions**:
- Restore from latest backup
- Run database recovery procedures
- Implement more frequent backups
- Consider switching to PostgreSQL for better reliability

### Log Analysis

#### Key Log Patterns

```bash
# Find error patterns
grep -E "(ERROR|FATAL|panic)" /var/log/fractalengine/*.log

# Monitor transaction processing
grep "Transaction processed" /var/log/fractalengine/*.log | tail -n 100

# Check blockchain sync status
grep "Block.*processed" /var/log/fractalengine/*.log | tail -n 20

# Database connection issues
grep -i "database.*error" /var/log/fractalengine/*.log
```

#### Performance Monitoring

```bash
# Monitor API response times
tail -f /var/log/nginx/access.log | grep fractal | awk '{print $10, $11}'

# Check service startup time
journalctl -u fractalengine | grep "Service started"

# Monitor resource usage trends
sar -u -r -d 1 60 > performance_report.txt
```

This deployment guide provides comprehensive coverage for deploying, configuring, and maintaining the Fractal Engine service in production environments. Follow the security hardening practices and monitoring recommendations to ensure reliable operation.
